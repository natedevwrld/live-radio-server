"use strict";
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.eventBusProvider = exports.eventBusFactory = exports.PUBLIC_EVENTS = exports.EVENT_BUS_TOKEN = void 0;
const events_1 = require("events");
const inverter_1 = require("@fridgefm/inverter");
const logger_1 = require("../../utils/logger");
const tokens_1 = require("../tokens");
exports.EVENT_BUS_TOKEN = (0, inverter_1.createToken)('event_bus');
exports.PUBLIC_EVENTS = {
    ERROR: 'error',
    INFO: 'einfo',
    START: 'estart',
    RESTART: 'erestart',
    NEXT_TRACK: 'enexttrack',
};
const eventBusFactory = (config) => {
    const emitter = new events_1.EventEmitter();
    const publicEventBus = {
        on: (eventName, handler) => emitter.on(eventName, handler),
        emit: (eventName, ...args) => emitter.emit(eventName, ...args),
    };
    if (config.verbose) {
        publicEventBus.on(exports.PUBLIC_EVENTS.INFO, (_a) => {
            var { level } = _a, rest = __rest(_a, ["level"]);
            return logger_1.logger.log(level || 'info', Object.assign({}, rest));
        });
        publicEventBus.on(exports.PUBLIC_EVENTS.ERROR, (event) => logger_1.logger.log('error', Object.assign(Object.assign({}, event), { message: event.error.message })));
    }
    publicEventBus.on(exports.PUBLIC_EVENTS.NEXT_TRACK, (tr, timings) => publicEventBus.emit(exports.PUBLIC_EVENTS.INFO, {
        event: exports.PUBLIC_EVENTS.NEXT_TRACK,
        message: tr.fsStats.stringified,
        timings,
    }));
    publicEventBus.on(exports.PUBLIC_EVENTS.START, (_, timings) => publicEventBus.emit(exports.PUBLIC_EVENTS.INFO, {
        event: exports.PUBLIC_EVENTS.START,
        message: 'Station started',
        timings,
    }));
    publicEventBus.on(exports.PUBLIC_EVENTS.RESTART, (_, timings) => publicEventBus.emit(exports.PUBLIC_EVENTS.INFO, {
        event: exports.PUBLIC_EVENTS.RESTART,
        message: 'Station restarted',
        timings,
    }));
    return publicEventBus;
};
exports.eventBusFactory = eventBusFactory;
exports.eventBusProvider = (0, inverter_1.injectable)({
    provide: exports.EVENT_BUS_TOKEN,
    useFactory: exports.eventBusFactory,
    inject: [tokens_1.CONFIG_TOKEN],
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnRzLnByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3Byb3ZpZGVycy9ldmVudHMvZXZlbnRzLnByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsbUNBQXNDO0FBQ3RDLGlEQUE2RDtBQUM3RCwrQ0FBNEM7QUFDNUMsc0NBQXlDO0FBSzVCLFFBQUEsZUFBZSxHQUFHLElBQUEsc0JBQVcsRUFBZ0MsV0FBVyxDQUFDLENBQUM7QUFFMUUsUUFBQSxhQUFhLEdBQUc7SUFDM0IsS0FBSyxFQUFFLE9BQU87SUFDZCxJQUFJLEVBQUUsT0FBTztJQUNiLEtBQUssRUFBRSxRQUFRO0lBQ2YsT0FBTyxFQUFFLFVBQVU7SUFDbkIsVUFBVSxFQUFFLFlBQVk7Q0FDaEIsQ0FBQztBQUVKLE1BQU0sZUFBZSxHQUFHLENBQUMsTUFBYyxFQUFFLEVBQUU7SUFDaEQsTUFBTSxPQUFPLEdBQUcsSUFBSSxxQkFBWSxFQUFjLENBQUM7SUFDL0MsTUFBTSxjQUFjLEdBQWtDO1FBQ3BELEVBQUUsRUFBRSxDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQztRQUMxRCxJQUFJLEVBQUUsQ0FBQyxTQUFTLEVBQUUsR0FBRyxJQUFJLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEdBQUcsSUFBSSxDQUFDO0tBQy9ELENBQUM7SUFFRixJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUU7UUFDbEIsY0FBYyxDQUFDLEVBQUUsQ0FBQyxxQkFBYSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQTZCLEVBQUUsRUFBRTtnQkFBakMsRUFBRSxLQUFLLE9BQXNCLEVBQWpCLElBQUksY0FBaEIsU0FBa0IsQ0FBRjtZQUFrQixPQUFBLGVBQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxJQUFJLE1BQU0sb0JBQU8sSUFBSSxFQUFHLENBQUE7U0FBQSxDQUFDLENBQUM7UUFFbkgsY0FBYyxDQUFDLEVBQUUsQ0FBQyxxQkFBYSxDQUFDLEtBQUssRUFBRSxDQUFDLEtBQWlCLEVBQUUsRUFBRSxDQUMzRCxlQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sa0NBQU8sS0FBSyxLQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sSUFBRyxDQUNoRSxDQUFDO0tBQ0g7SUFFRCxjQUFjLENBQUMsRUFBRSxDQUFDLHFCQUFhLENBQUMsVUFBVSxFQUFFLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRSxFQUFFLENBQzFELGNBQWMsQ0FBQyxJQUFJLENBQUMscUJBQWEsQ0FBQyxJQUFJLEVBQUU7UUFDdEMsS0FBSyxFQUFFLHFCQUFhLENBQUMsVUFBVTtRQUMvQixPQUFPLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxXQUFXO1FBQy9CLE9BQU87S0FDUixDQUFDLENBQ0gsQ0FBQztJQUVGLGNBQWMsQ0FBQyxFQUFFLENBQUMscUJBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FDcEQsY0FBYyxDQUFDLElBQUksQ0FBQyxxQkFBYSxDQUFDLElBQUksRUFBRTtRQUN0QyxLQUFLLEVBQUUscUJBQWEsQ0FBQyxLQUFLO1FBQzFCLE9BQU8sRUFBRSxpQkFBaUI7UUFDMUIsT0FBTztLQUNSLENBQUMsQ0FDSCxDQUFDO0lBRUYsY0FBYyxDQUFDLEVBQUUsQ0FBQyxxQkFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUN0RCxjQUFjLENBQUMsSUFBSSxDQUFDLHFCQUFhLENBQUMsSUFBSSxFQUFFO1FBQ3RDLEtBQUssRUFBRSxxQkFBYSxDQUFDLE9BQU87UUFDNUIsT0FBTyxFQUFFLG1CQUFtQjtRQUM1QixPQUFPO0tBQ1IsQ0FBQyxDQUNILENBQUM7SUFFRixPQUFPLGNBQWMsQ0FBQztBQUN4QixDQUFDLENBQUM7QUF4Q1csUUFBQSxlQUFlLG1CQXdDMUI7QUFFVyxRQUFBLGdCQUFnQixHQUFHLElBQUEscUJBQVUsRUFBQztJQUN6QyxPQUFPLEVBQUUsdUJBQWU7SUFDeEIsVUFBVSxFQUFFLHVCQUFlO0lBQzNCLE1BQU0sRUFBRSxDQUFDLHFCQUFZLENBQVU7Q0FDaEMsQ0FBQyxDQUFDIn0=