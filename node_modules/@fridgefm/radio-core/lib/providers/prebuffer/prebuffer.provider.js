"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.prebufferProvider = exports.prebufferFactory = exports.PREBUFFER_TOKEN = void 0;
const inverter_1 = require("@fridgefm/inverter");
const tokens_1 = require("../tokens");
exports.PREBUFFER_TOKEN = (0, inverter_1.createToken)('prebuffer');
const prebufferFactory = (config) => {
    const { prebufferLength } = config;
    const storage = [];
    return {
        modify: (chunks) => {
            chunks.forEach((ch) => {
                if (storage.length >= prebufferLength) {
                    storage.shift();
                }
                storage.push(ch);
            });
        },
        getStorage: () => {
            const totalPrebufferLength = (storage[0] || []).length * prebufferLength;
            return Buffer.concat(storage, totalPrebufferLength);
        },
    };
};
exports.prebufferFactory = prebufferFactory;
exports.prebufferProvider = (0, inverter_1.injectable)({
    provide: exports.PREBUFFER_TOKEN,
    scope: 'scoped',
    useFactory: exports.prebufferFactory,
    inject: [tokens_1.CONFIG_TOKEN],
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlYnVmZmVyLnByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3Byb3ZpZGVycy9wcmVidWZmZXIvcHJlYnVmZmVyLnByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlEQUE2RDtBQUM3RCxzQ0FBeUM7QUFRNUIsUUFBQSxlQUFlLEdBQUcsSUFBQSxzQkFBVyxFQUFhLFdBQVcsQ0FBQyxDQUFDO0FBRTdELE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxNQUFxQixFQUFFLEVBQUU7SUFDeEQsTUFBTSxFQUFFLGVBQWUsRUFBRSxHQUFHLE1BQU0sQ0FBQztJQUNuQyxNQUFNLE9BQU8sR0FBYSxFQUFFLENBQUM7SUFFN0IsT0FBTztRQUNMLE1BQU0sRUFBRSxDQUFDLE1BQWdCLEVBQUUsRUFBRTtZQUMzQixNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUU7Z0JBQ3BCLElBQUksT0FBTyxDQUFDLE1BQU0sSUFBSSxlQUFlLEVBQUU7b0JBQ3JDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztpQkFDakI7Z0JBRUQsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNuQixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFDRCxVQUFVLEVBQUUsR0FBRyxFQUFFO1lBQ2YsTUFBTSxvQkFBb0IsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLEdBQUcsZUFBZSxDQUFDO1lBQ3pFLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztRQUN0RCxDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUMsQ0FBQztBQW5CVyxRQUFBLGdCQUFnQixvQkFtQjNCO0FBRVcsUUFBQSxpQkFBaUIsR0FBRyxJQUFBLHFCQUFVLEVBQUM7SUFDMUMsT0FBTyxFQUFFLHVCQUFlO0lBQ3hCLEtBQUssRUFBRSxRQUFRO0lBQ2YsVUFBVSxFQUFFLHdCQUFnQjtJQUM1QixNQUFNLEVBQUUsQ0FBQyxxQkFBWSxDQUFVO0NBQ2hDLENBQUMsQ0FBQyJ9